{% extends "orgs/settings_base.html" %}
{% from "macros/components.html" import role_badge %}

{% block settings_content %}
<div class="stats">
    <div class="stat">
        <div class="stat-value">{{ members|length }}</div>
        <div class="stat-label">Total Members</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ admin_count }}</div>
        <div class="stat-label">Admins</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ disabled_count }}</div>
        <div class="stat-label">Disabled</div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        <h2>All Members</h2>
    </div>

    {% if members %}
    <table class="data-table">
        <thead>
            <tr>
                <th scope="col">Email</th>
                <th scope="col">Role</th>
                <th scope="col">Status</th>
                <th scope="col">Joined</th>
                <th scope="col" class="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td>
                    {{ member.email or member.user_id[:8] ~ '...' }}
                    {% if member.user_id == current_user_id %}
                    <span class="badge">You</span>
                    {% endif %}
                </td>
                <td>
                    {% set member_role = 'owner' if member.user_id == org.owner_id else ('admin' if member.is_admin else 'member') %}
                    {{ role_badge(member_role) }}
                </td>
                <td>
                    {% if member.disabled_at %}
                    <span class="status status-disabled">Disabled</span>
                    {% elif member.email_verified_at %}
                    <span class="status status-verified">Verified</span>
                    {% else %}
                    <span class="status status-pending">Unverified</span>
                    {% endif %}
                </td>
                <td class="meta">{{ member.created_at.strftime('%Y-%m-%d') if member.created_at else '-' }}</td>
                <td class="actions">
                    <a href="{{ url_for('views.orgs.user_sessions', org_id=org.org_id, user_id=member.user_id) }}" class="btn btn-sm">Sessions</a>

                    {% if member.user_id != current_user_id and member.user_id != org.owner_id %}
                        {% if member.is_admin %}
                        <form method="post" action="{{ url_for('views.orgs.revoke_admin', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm" data-confirm="Revoke admin permission?">Revoke Admin</button>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('views.orgs.grant_admin', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-primary">Make Admin</button>
                        </form>
                        {% endif %}

                        {% if member.disabled_at %}
                        <form method="post" action="{{ url_for('views.orgs.enable_user', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-primary">Enable</button>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('views.orgs.disable_user', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" data-confirm="Disable this user?">Disable</button>
                        </form>
                        {% endif %}

                        <form action="{{ url_for('views.orgs.remove_member', org_id=org.org_id, member_id=member.user_id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" data-confirm="Remove this member from the organization?">Remove</button>
                        </form>

                        {% if not member.disabled_at %}
                        <button type="button" class="btn btn-sm btn-impersonate" data-impersonate data-user-id="{{ member.user_id }}" data-user-email="{{ member.email }}" data-impersonate-url="{{ url_for('views.orgs.start_impersonation', org_id=org.org_id, user_id='__USER_ID__') }}">View as User</button>
                        {% endif %}
                    {% elif member.user_id == org.owner_id %}
                        <span class="text-muted">Owner</span>
                    {% endif %}

                    {% if is_owner and member.user_id != org.owner_id and member.user_id != current_user_id %}
                    <form method="post" action="{{ url_for('views.orgs.transfer_ownership', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm" data-confirm="Transfer ownership to this user? You will become an admin.">Make Owner</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-message">No members found</div>
    {% endif %}
</div>

<div class="section">
    <div class="section-header">
        <h2>Invite Members</h2>
    </div>
    <form action="{{ url_for('views.orgs.create_invite', org_id=org.org_id) }}" method="post" class="invite-form">
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email (optional)</label>
                <input type="email" id="email" name="email" placeholder="Leave empty for anyone with link">
            </div>
            <div class="form-group">
                <label for="role">Role</label>
                <select id="role" name="role">
                    <option value="member">Member</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expires_days">Expires in</label>
                <select id="expires_days" name="expires_days">
                    <option value="1">1 day</option>
                    <option value="7" selected>7 days</option>
                    <option value="30">30 days</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Invite Link</button>
    </form>

    {% if invites %}
    <h3 class="mt-3 mb-2">Pending Invites</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th scope="col">Email</th>
                <th scope="col">Role</th>
                <th scope="col">Expires</th>
                <th scope="col">Link</th>
            </tr>
        </thead>
        <tbody>
            {% for invite in invites %}
            <tr>
                <td>{{ invite.email or 'Anyone with link' }}</td>
                <td>{{ invite.role }}</td>
                <td class="meta">{{ invite.expires_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <code class="invite-code">{{ url_for('views.orgs.view_invite', code=invite.code, _external=True) }}</code>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- Impersonation Modal -->
<div id="impersonateModal" class="modal d-none">
    <div class="modal-content">
        <div class="modal-header">
            <h3>View as User</h3>
            <button type="button" class="modal-close" aria-label="Close" data-dismiss="modal">&times;</button>
        </div>
        <form id="impersonateForm" method="post" action="">
            <div class="modal-body">
                <p>You will view the application as <strong id="impersonateEmail"></strong>.</p>
                <div class="impersonate-notice">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                    <span>All actions are logged for audit compliance.</span>
                </div>
                <div class="form-group">
                    <label for="impersonateReason">Reason (required)</label>
                    <input type="text" id="impersonateReason" name="reason" placeholder="e.g., Support ticket #123, Bug investigation" required>
                    <small class="form-hint">This will be recorded in the audit log.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Start Session</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
