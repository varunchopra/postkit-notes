{% extends "orgs/settings_base.html" %}

{% block settings_content %}
<div class="audit-tabs">
    <a href="{{ url_for('views.orgs.settings_audit', org_id=org.org_id) }}" class="audit-tab {% if audit_tab == 'permissions' %}active{% endif %}">Permissions</a>
    <a href="{{ url_for('views.orgs.settings_audit_impersonations', org_id=org.org_id) }}" class="audit-tab {% if audit_tab == 'impersonations' %}active{% endif %}">Impersonations</a>
</div>

<div class="section">
    <div class="section-header">
        <h2>Filters</h2>
    </div>
    <form method="get" class="inline-form mb-3">
        <div class="form-group">
            <label for="event_type">Event Type</label>
            <select name="event_type" id="event_type">
                <option value="">All Events</option>
                <option value="grant" {% if filter_event_type == 'grant' %}selected{% endif %}>Grant</option>
                <option value="revoke" {% if filter_event_type == 'revoke' %}selected{% endif %}>Revoke</option>
            </select>
        </div>
        <div class="form-group">
            <label for="actor_id">Actor ID</label>
            <input type="text" name="actor_id" id="actor_id" value="{{ filter_actor_id or '' }}" placeholder="e.g., user:abc123...">
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
    </form>
</div>

<div class="section">
    <div class="section-header">
        <h2>Events ({{ events|length }})</h2>
    </div>

    {% if events %}
    <table class="data-table">
        <thead>
            <tr>
                <th scope="col">Time</th>
                <th scope="col">Event</th>
                <th scope="col">Actor</th>
                <th scope="col">Details</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr>
                <td class="meta text-nowrap">{{ event.event_time.strftime('%Y-%m-%d %H:%M') if event.event_time else 'N/A' }}</td>
                <td>
                    {% if event.event_type == 'tuple_created' %}
                    <span class="event-badge event-grant">GRANT</span>
                    {% elif event.event_type == 'tuple_deleted' %}
                    <span class="event-badge event-revoke">REVOKE</span>
                    {% elif event.event_type == 'hierarchy_created' %}
                    <span class="event-badge">HIERARCHY</span>
                    {% else %}
                    <span class="event-badge">{{ event.event_type|upper }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if event.actor_id %}
                    <code>{{ event.actor_id }}</code>
                    {% if event.on_behalf_of %}
                    <div class="impersonation-context">
                        <span class="impersonation-badge" title="{{ event.reason or 'Impersonation' }}">⇢ as {{ event.on_behalf_of }}</span>
                    </div>
                    {% endif %}
                    {% else %}
                    <code class="text-secondary">system</code>
                    {% endif %}
                </td>
                <td>
                    {% if event.event_type == 'tuple_created' or event.event_type == 'tuple_deleted' %}
                    <span class="tuple-display">
                        <code class="tuple-entity" title="{{ event.subject[0] }}:{{ event.subject[1] }}">({{ event.subject[0] }}, {{ event.subject[1][:8] }}...)</code>
                        <span class="tuple-arrow">─{{ event.relation }}→</span>
                        <code class="tuple-entity" title="{{ event.resource[0] }}:{{ event.resource[1] }}">({{ event.resource[0] }}, {{ event.resource[1][:8] }}...)</code>
                    </span>
                    {% elif event.event_type == 'hierarchy_created' %}
                    <code>{{ event.resource[0] }}.{{ event.resource[1] }}</code> implies <code>{{ event.relation }}</code>
                    {% else %}
                    <code title="{{ event.resource[0] }}:{{ event.resource[1] }}">{{ event.resource[0] }}:{{ event.resource[1] }}</code> / {{ event.relation }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-message">No audit events found for the selected filters</div>
    {% endif %}
</div>
{% endblock %}
