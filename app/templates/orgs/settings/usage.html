{% extends "orgs/settings_base.html" %}

{% block settings_content %}
{% set seat_cost = seats_used * seat_price %}
{% set total_cost = seat_cost + storage_cost %}

<div class="section bill-summary">
    <div class="bill-header">
        <div class="plan-badge">{{ plan.name }}</div>
        <div class="bill-total">
            <div class="bill-total-label">Estimated Monthly Bill</div>
            <div class="bill-total-amount">${{ "%.2f"|format(total_cost) }}</div>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        <h2>Billing Breakdown</h2>
    </div>
    <table class="data-table billing-table">
        <thead>
            <tr>
                <th scope="col">Item</th>
                <th scope="col">Usage</th>
                <th scope="col">Rate</th>
                <th scope="col" class="text-right">Cost</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Seats</td>
                <td>
                    {% if is_unlimited %}
                    {{ seats_used }} (unlimited)
                    {% else %}
                    {{ seats_used }} of {{ seats_allocated }}
                    {% endif %}
                </td>
                <td>{% if seat_price %}${{ seat_price }}/seat{% else %}Included{% endif %}</td>
                <td class="text-right">${{ "%.2f"|format(seat_cost) }}</td>
            </tr>
            <tr>
                <td>Storage</td>
                <td>{{ "{:,}".format(storage_used) }} chars</td>
                <td>{% if storage_rate %}${{ "%.2f"|format(storage_rate * 1000) }}/1k chars{% else %}Custom{% endif %}</td>
                <td class="text-right">${{ "%.2f"|format(storage_cost) }}</td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><strong>Total</strong></td>
                <td class="text-right"><strong>${{ "%.2f"|format(total_cost) }}</strong></td>
            </tr>
        </tfoot>
    </table>
    {% if not is_unlimited and seats_used >= seats_allocated %}
    <p class="usage-warning">No seats available. Remove members or upgrade your plan.</p>
    {% endif %}
</div>

{% if user_storage %}
<div class="section">
    <div class="section-header">
        <h2>Storage by Member</h2>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th scope="col">Member</th>
                <th scope="col">Characters</th>
                <th scope="col" class="text-right">Cost</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            {% set chars = user_storage.get(member.user_id, 0) %}
            {% set cost = chars * storage_rate %}
            <tr>
                <td>{{ member.email }}</td>
                <td>{{ "{:,}".format(chars) }}</td>
                <td class="text-right">${{ "%.2f"|format(cost) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
